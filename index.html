<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YT-MultiPlayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f0f0f;
            color: #ffffff;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 12px;
            background: #272727;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .grid-dynamic {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f0f0f; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="min-h-screen flex overflow-hidden">

    <div class="flex-1 h-screen overflow-y-auto relative">
        <!-- Floating Toggle Button -->
        <button 
            id="toggleSidebar"
            onclick="toggleSidebar()" 
            class="fixed top-6 right-6 z-50 bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-full shadow-2xl transition-transform hidden hover:scale-110 active:scale-95"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
            </svg>
        </button>

        <!-- Initial Welcome View -->
        <div id="welcomeView" class="min-h-full flex flex-col items-center justify-center p-6 text-center">
            <div class="max-w-2xl w-full space-y-8 animate-in fade-in zoom-in duration-500">
                <div class="flex flex-col items-center">
                    <div class="flex gap-2">
                        <span class="px-2 py-1 bg-red-600 rounded text-[10px] font-bold">YouTube</span>
                        <span class="px-2 py-1 bg-purple-600 rounded text-[10px] font-bold">Twitch</span>
                        <span class="px-2 py-1 bg-blue-600 rounded text-[10px] font-bold">ニコ生</span>
                        <span class="px-2 py-1 bg-blue-400 rounded text-[10px] font-bold">ツイキャス</span>
                    </div>
                    <h1 class="text-5xl font-black mt-6 tracking-tighter text-white">YT-MultiPlayer</h1>
                    <p class="text-gray-400 mt-2 font-medium">URLを貼り付けて動画を追加、またはキーワードで検索</p>
                </div>

                <div class="bg-[#1e1e1e] p-8 rounded-3xl shadow-2xl border border-white/10 space-y-6">
                    <div class="space-y-4">
                        <div class="relative flex items-center">
                            <input 
                                type="text" 
                                id="combinedInput" 
                                placeholder="配信URLを貼り付け、または検索..." 
                                class="w-full bg-black/50 border border-white/10 rounded-2xl px-6 py-5 pr-32 focus:outline-none focus:ring-2 focus:ring-indigo-600 transition-all text-lg"
                                onkeypress="if(event.key === 'Enter') handleSmartInput('combinedInput')"
                            >
                            <button 
                                onclick="handleSmartInput('combinedInput')" 
                                class="absolute right-3 bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded-xl font-bold shadow-lg transition-all"
                            >
                                追加
                            </button>
                        </div>
                        <div class="flex justify-center gap-4 text-[10px] text-gray-500 uppercase tracking-widest font-semibold">
                            <span>YouTube</span>
                            <span class="text-gray-700">•</span>
                            <span>Twitch</span>
                            <span class="text-gray-700">•</span>
                            <span>NicoNico</span>
                            <span class="text-gray-700">•</span>
                            <span>TwitCasting</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <main id="videoGrid" class="grid-dynamic max-w-[1800px] mx-auto p-4 md:p-8 pt-20 hidden">
            <!-- Videos injected here -->
        </main>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed right-0 top-0 bottom-0 w-80 lg:w-96 bg-[#0f0f0f] border-l border-white/10 flex flex-col z-40 translate-x-full shadow-2xl">
        <div class="p-4 border-b border-white/10 bg-[#121212] flex flex-col gap-4">
            <div class="flex items-center justify-between">
                <h2 class="text-sm font-bold tracking-widest uppercase text-gray-400">Search & Add</h2>
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg>
                </button>
            </div>
            <div class="relative">
                <input 
                    type="text" 
                    id="sidebarInput" 
                    placeholder="URLまたはキーワード..." 
                    class="w-full bg-[#1e1e1e] border border-white/10 rounded-lg px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-indigo-600 text-sm"
                    onkeypress="if(event.key === 'Enter') handleSmartInput('sidebarInput')"
                >
            </div>
        </div>

        <div id="searchResults" class="flex-1 overflow-y-auto p-4 space-y-4 bg-black/20">
            <div class="text-center text-gray-500 py-10 text-xs">
                YouTubeの検索結果がここに表示されます
            </div>
        </div>

        <!-- API Settings -->
        <div class="border-t border-white/10 bg-[#121212]">
            <button onclick="toggleApiSettings()" class="w-full p-4 flex items-center justify-between text-xs text-gray-400 hover:text-white transition-colors">
                <span class="flex items-center gap-2 uppercase tracking-widest font-bold">YouTube API設定</span>
                <svg id="apiSettingsChevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256" class="transition-transform"><path d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80a8,8,0,0,1,11.32-11.32L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"></path></svg>
            </button>
            <div id="apiSettingsPanel" class="hidden p-4 pt-0 space-y-3">
                <div class="flex gap-2">
                    <input type="password" id="apiKey" placeholder="Google API Key" class="flex-1 bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-xs outline-none">
                    <button onclick="saveApiKey()" class="bg-indigo-600 text-white text-[10px] px-4 rounded-lg font-bold">保存</button>
                </div>
            </div>
        </div>
    </aside>

    <script>
        const videoGrid = document.getElementById('videoGrid');
        const welcomeView = document.getElementById('welcomeView');
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebar');
        const searchResults = document.getElementById('searchResults');
        const apiSettingsPanel = document.getElementById('apiSettingsPanel');
        const apiSettingsChevron = document.getElementById('apiSettingsChevron');
        
        let youtubeApiKey = localStorage.getItem('youtube_api_key') || '';
        let isSidebarOpen = false;

        if (youtubeApiKey) document.getElementById('apiKey').value = youtubeApiKey;

        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (key) {
                youtubeApiKey = key;
                localStorage.setItem('youtube_api_key', key);
                toggleApiSettings();
            }
        }

        function toggleApiSettings() {
            const isHidden = apiSettingsPanel.classList.toggle('hidden');
            apiSettingsChevron.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
        }

        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            sidebar.classList.toggle('translate-x-full', !isSidebarOpen);
        }

        function getStreamData(url) {
            // YouTube
            const ytRegExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const ytMatch = url.match(ytRegExp);
            if (ytMatch && ytMatch[7].length == 11) {
                return { type: 'YouTube', embedUrl: `https://www.youtube.com/embed/${ytMatch[7]}?autoplay=1&mute=1`, id: ytMatch[7] };
            }

            // Twitch
            if (url.includes('twitch.tv/')) {
                const parts = url.split('twitch.tv/')[1].split(/[/?#]/);
                const channel = parts[0];
                const parent = window.location.hostname || 'localhost';
                return { type: 'Twitch', embedUrl: `https://player.twitch.tv/?channel=${channel}&parent=${parent}&autoplay=true&muted=true`, id: channel };
            }

            // ニコニコ生放送
            if (url.includes('live.nicovideo.jp/watch/')) {
                const liveId = url.split('watch/')[1].split(/[/?#]/)[0];
                return { type: 'ニコ生', embedUrl: `https://live.nicovideo.jp/embed/${liveId}`, id: liveId };
            }

            // ツイキャス
            if (url.includes('twitcasting.tv/')) {
                const user = url.split('twitcasting.tv/')[1].split(/[/?#]/)[0];
                return { type: 'ツイキャス', embedUrl: `https://twitcasting.tv/${user}/embeddedplayer/show?auto_play=true&default_mute=true`, id: user };
            }

            return null;
        }

        async function handleSmartInput(inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            if (!value) return;

            const stream = getStreamData(value);

            if (stream) {
                addStreamToGrid(stream);
                input.value = '';
                if (isSidebarOpen) toggleSidebar();
            } else {
                if (!isSidebarOpen) {
                    toggleSidebar();
                    switchToGridView();
                }
                document.getElementById('sidebarInput').value = value;
                await searchYouTube(value);
                input.value = '';
                input.blur();
            }
        }

        function switchToGridView() {
            welcomeView.classList.add('hidden');
            videoGrid.classList.remove('hidden');
            toggleBtn.classList.remove('hidden');
        }

        function addStreamToGrid(stream) {
            switchToGridView();
            
            const card = document.createElement('div');
            card.className = 'group relative bg-[#1e1e1e] rounded-2xl overflow-hidden border border-white/10 hover:border-white/30 transition-all shadow-lg animate-in slide-in-from-bottom-4 duration-500';
            
            const badgeColors = {
                'YouTube': 'bg-red-600',
                'Twitch': 'bg-purple-600',
                'ニコ生': 'bg-blue-600',
                'ツイキャス': 'bg-blue-400'
            };

            card.innerHTML = `
                <div class="video-container">
                    <iframe src="${stream.embedUrl}" frameborder="0" allowfullscreen allow="autoplay; encrypted-media"></iframe>
                </div>
                <div class="p-3 flex justify-between items-center bg-[#1a1a1a]">
                    <div class="flex items-center gap-2">
                        <span class="${badgeColors[stream.type] || 'bg-gray-600'} text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-tighter">${stream.type}</span>
                        <span class="text-[10px] text-gray-500 font-mono truncate max-w-[150px]">${stream.id}</span>
                    </div>
                    <button onclick="this.closest('.group').remove(); checkEmpty();" class="text-gray-400 hover:text-red-500 transition-colors p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm112,168a8,8,0,0,1-8,8H64a8,8,0,0,1-8-8V64H208Z"></path></svg>
                    </button>
                </div>
            `;
            videoGrid.appendChild(card);
        }

        function checkEmpty() {
            if (videoGrid.querySelectorAll('.group').length === 0) {
                welcomeView.classList.remove('hidden');
                videoGrid.classList.add('hidden');
                toggleBtn.classList.add('hidden');
                if (isSidebarOpen) toggleSidebar();
            }
        }

        async function searchYouTube(query) {
            if (!youtubeApiKey) {
                searchResults.innerHTML = `<div class="text-center p-6 text-xs text-gray-500 italic">APIキーを設定するとYouTube内を検索できます</div>`;
                return;
            }
            searchResults.innerHTML = '<div class="text-center p-6 text-xs animate-pulse">Searching...</div>';

            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=15&q=${encodeURIComponent(query)}&type=video&key=${youtubeApiKey}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);

                searchResults.innerHTML = '';
                data.items.forEach(item => {
                    const videoId = item.id.videoId;
                    const { title, thumbnails } = item.snippet;
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-white/5 rounded-xl overflow-hidden cursor-pointer hover:bg-white/10 transition-all border border-white/5 group';
                    itemEl.onclick = () => addStreamToGrid({ type: 'YouTube', embedUrl: `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1`, id: videoId });
                    itemEl.innerHTML = `
                        <div class="relative">
                            <img src="${thumbnails.medium.url}" class="w-full aspect-video object-cover">
                            <div class="absolute inset-0 bg-indigo-600/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        </div>
                        <div class="p-2 text-xs font-medium line-clamp-2 leading-tight">${title}</div>
                    `;
                    searchResults.appendChild(itemEl);
                });
            } catch (e) {
                searchResults.innerHTML = `<div class="text-red-400 p-6 text-xs text-center">Error: ${e.message}</div>`;
            }
        }
    </script>
</body>
</html>
